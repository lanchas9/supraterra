<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EXPO SUPTRATERRA 2021</title>
    <link rel="stylesheet" href="./assets/css/reportes.css">
    <link rel="icon" type="image/jpg" href="/assets/img/favicon.jpg" />
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,500,800" rel="stylesheet">
    <link href="https://unpkg.com/tabulator-tables@4.9.3/dist/css/tabulator.min.css" rel="stylesheet">
    <script type="text/javascript" src="https://unpkg.com/tabulator-tables@4.9.3/dist/js/tabulator.min.js"></script>
    <script type="text/javascript" src="https://oss.sheetjs.com/sheetjs/xlsx.full.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tabulator/4.9.3/css/tabulator_midnight.min.css" rel="stylesheet">
</head>
<body>
    <h1 id="titulo" class="titulo">Titulo</h1>
    <h2 id="numeroRenglones" class="titulo"></h2>
    <img id="download-xlsx" class="imagenLogo center" src="./assets/img/mobile/logo_expo.png" alt="" srcset="">
    <br>
    <div id="example-table"></div>
<script>
    const queryString = window.location.search;
    const urlParams = new URLSearchParams(queryString);
    const reporte = urlParams.get('reporte') 
    const element = document.getElementById("titulo");
    element.innerHTML = dameTitulo(reporte)

    fetchReportJSON()
    async function fetchReportJSON() {
        const response = await fetch('https://mosaico.app:4000/supraterra/' + reporte);
        const tabledata = await response.json();
        if (tabledata.result == 'True'){
            if((reporte == 'reporteUsuariosRegistrados') || (reporte == 'reporteUsuariosRegistradosIncluidoDemo')){
                tabledata.message.forEach(element => {
                element.Reenviar = ''
                element.Actualizar = ''
                });
            }
            return tabledata.message;
        }else{
            let array = []
            array.push({data: "No existen datos"})
            return array
            
        }
    }

    fetchReportJSON().then(tabledata => {
        var table = new Tabulator("#example-table", {
            height:"800px",
            layout:"fitColumns",
            data:tabledata,
            autoColumns:true,
            autoColumnsDefinitions:function(definitions){
            //definitions - array of column definition objects

            definitions.forEach((column) => {
                column.headerFilter = true; // add header filter to every column
                column.hozAlign="center"
                if((reporte == 'reporteUsuariosRegistrados') || (reporte == 'reporteUsuariosRegistradosIncluidoDemo')){
                    let columnasEditables = ['username', 'nombreUsuario', 'apellidoPaterno', 'apellidoMaterno', 'numeroCelular']
                    if(columnasEditables.some(r=>columnasEditables.includes(column.title))){
                        column.editor = true
                    }
                }
            });
            return definitions;
            },
            // rowClick:function(e, row){
            // //e - the click event object
            // //row - row component
            // // reenviaMail(row.getCells()[1].getValue())
            // console.log('renglon completo')
            // }
            cellClick:function(e, cell){
                //e - the click event object
                //cell - cell component
                console.log('cell clickeada')
                if (cell.getValue() == ''){
                    let username = cell.getRow().getData().username
                    if (confirm('Confirmas el reenv铆o del correo para: ' + username)) {
                        // Send it!
                            reenviaMail(username)
                        } else {
                        // Do nothing!
                    }
                }else if (cell.getValue() == ''){
                    let username = cell.getRow().getData().username
                    if (confirm('Confirmas que quieres actualizar los datos de: ' + username)) {
                        // Send it!
                            actualizaDB(cell.getRow().getData())
                            console.log(cell.getRow().getData())
                        } else {
                        // Do nothing!
                    }
                }
            },
            cellEdited:function(cell){
                //cell - cell component
                //console.log(cell.getValue())
            },
        });
        var count = table.getDataCount();
        const element = document.getElementById("numeroRenglones");
        element.innerHTML = 'N煤mero Renglones: ' + count

        //trigger download of data.xlsx file
        document.getElementById("download-xlsx").addEventListener("click", function(){
        table.download("xlsx", "data.xlsx", {sheetName:"Expo Supraterra 2021"});
        });
    });

    function dameTitulo(titulo){
        let nuevo = titulo.match(/([A-Z]?[^A-Z]*)/g).slice(0,-1).join(" ")
        
        return nuevo.charAt(0).toUpperCase() + nuevo.slice(1)
    }

    function actualizaDB(username){
        const data = username
        let url1 = 'https://mosaico.app:4000/supraterra/actualizaUsuario'
        fetch(url1, {
        method: 'POST',
        headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json'
        },
        mode: 'cors', // no-cors, *cors, same-origin
        body: JSON.stringify(data)
        })
        .then(function(response) {
        if(response.ok) {
            return response.json()
        } else {
            throw "Error en la llamada Ajax";
        }

        })
        .then(function(json) {
            if(json.result == "True"){
                alert('La actualizaci贸n de: ' + username.username + ' se realiz贸 con 茅xito');
            }else{
                alert('Error desconocido en la actualizaci贸n');
            }
        })
        .catch(function(err) {
            console.log(err);
        });
    }

    function reenviaMail(username){
        const data = {
            username : username
        }
        let url1 = 'https://mosaico.app:4000/supraterra/reenviaMailaUsuario'
        let url2 = 'https://mosaico.app:4000/helloMySql'
        fetch(url1, {
        method: 'POST',
        headers: {
            'Accept': 'application/json',
            'Content-Type': 'application/json'
        },
        mode: 'cors', // no-cors, *cors, same-origin
        body: JSON.stringify(data)
        })
        .then(function(response) {
        if(response.ok) {
            return response.json()
        } else {
            throw "Error en la llamada Ajax";
        }

        })
        .then(function(json) {
            if(json.result == "True"){
                alert('El reenv铆o a: ' + username.username + 'se realiz贸 con 茅xito');
            }else{
                alert('Error desconocido en el reenv铆o del mail');
            }
        })
        .catch(function(err) {
            console.log(err);
        });
    }
</script>
</body>
</html>